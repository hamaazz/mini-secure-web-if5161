{% extends "base.html" %}

{% block content %}
<h3 class="mb-3">Admin Panel</h3>
<p>Halo, <strong>Administrator</strong>.</p>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body text-center">
        <h6 class="text-muted mb-1">Total User</h6>
        <h3>{{ total_users }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body text-center">
        <h6 class="text-muted mb-1">Total File</h6>
        <h3>{{ total_files }}</h3>
      </div>
    </div>
  </div>
</div>

<h5 class="mt-3 mb-2">Manajemen User</h5>
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="table-responsive">
      <table id="usersTable" class="table table-striped table-bordered align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Role</th>
            <th>Jumlah File</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
        {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.username }}</td>
            <td>
              {% if u.is_admin %}
                <span class="badge bg-danger">Admin</span>
              {% else %}
                <span class="badge bg-secondary">User</span>
              {% endif %}
            </td>
            <td>{{ u.files|length }}</td>
            <td>
              {% if not u.is_admin %}
              <form method="post"
                    action="{{ url_for('admin_delete_user', user_id=u.id) }}"
                    style="display:inline"
                    class="delete-user-form">
                <!-- ===== CSRF Token ===== -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <button type="submit"
                        class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="tooltip"
                        data-bs-title="Hapus user & semua file">
                  <i class="bi bi-person-x"></i>
                </button>
              </form>
              {% else %}
              -
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<h5 class="mt-3 mb-2">Manajemen File</h5>
<div class="card shadow-sm">
  <div class="card-body">
    <div class="table-responsive">
      <table id="allFilesTable" class="table table-striped table-bordered align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Owner</th>
            <th>Nama File</th>
            <th>Deskripsi</th>
            <th>Waktu Upload</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
        {% for f, username in files %}
          <tr>
            <td>{{ f.id }}</td>
            <td>{{ username }}</td>
            <td style="word-break: break-all;">{{ f.original_filename }}</td>
            <td>{{ f.description or "-" }}</td>
            <td>{{ f.uploaded_at.strftime("%d %b %Y %H:%M") }}</td>
            <td>
              <a href="{{ url_for('download', file_id=f.id) }}"
                 class="btn btn-sm btn-primary me-1"
                 data-bs-toggle="tooltip"
                 data-bs-title="Download">
                <i class="bi bi-download"></i>
              </a>

              <form method="post"
                    action="{{ url_for('delete_file', file_id=f.id) }}"
                    style="display:inline"
                    class="delete-file-form">
                <!-- ===== CSRF Token ===== -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <button type="submit"
                        class="btn btn-sm btn-danger"
                        data-bs-toggle="tooltip"
                        data-bs-title="Hapus file">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function () {
    $('#usersTable').DataTable({
      language: {
        search: "Cari:",
        lengthMenu: "Tampilkan _MENU_ baris",
        info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
        infoEmpty: "Tidak ada data",
        zeroRecords: "Data tidak ditemukan",
        paginate: {
          first: "Pertama",
          last: "Terakhir",
          next: "Berikutnya",
          previous: "Sebelumnya"
        }
      },
      order: [[0, "asc"]]
    });

    $('#allFilesTable').DataTable({
      language: {
        search: "Cari:",
        lengthMenu: "Tampilkan _MENU_ baris",
        info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
        infoEmpty: "Tidak ada data",
        zeroRecords: "Data tidak ditemukan",
        paginate: {
          first: "Pertama",
          last: "Terakhir",
          next: "Berikutnya",
          previous: "Sebelumnya"
        }
      },
      order: [[4, "desc"]]
    });

    // Konfirmasi hapus user
    $('.delete-user-form').on('submit', function(e) {
      e.preventDefault();
      const form = this;
      Swal.fire({
        title: 'Yakin hapus user ini?',
        text: 'User dan semua file miliknya akan dihapus permanen.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Ya, hapus',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });

    // Konfirmasi hapus file (admin)
    $('.delete-file-form').on('submit', function(e) {
      e.preventDefault();
      const form = this;
      Swal.fire({
        title: 'Yakin hapus file ini?',
        text: 'File ini akan dihapus permanen.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Ya, hapus',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });

  });
</script>
{% endblock %}